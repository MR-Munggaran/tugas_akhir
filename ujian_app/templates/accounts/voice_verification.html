<!DOCTYPE html>
<html>
<head>
    <title>Rekam Suara</title>
    <script src="https://cdn.jsdelivr.net/npm/recordrtc@5.4.6/RecordRTC.min.js"></script>
</head>
<body>
    <div class="voice-verification">
        <h2>Verifikasi Suara</h2>
        <form id="voiceForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="recorder">
                <button type="button" id="recordButton">Mulai Rekam</button>
                <audio id="audioPreview" controls></audio>
                <input type="file" name="audio" id="audioInput" accept="audio/*" hidden>
            </div>
            <button type="submit" class="btn-submit">Verifikasi</button>
        </form>
        
        {% if error %}
        <div class="alert error">{{ error }}</div>
        {% endif %}
    </div>
    
    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let mediaStream; // Simpan referensi stream
    
        recordButton.addEventListener('click', async () => {
            try {
                if(isRecording) {
                    // Stop rekaman
                    mediaRecorder.stop();
                    mediaStream.getTracks().forEach(track => track.stop()); // Hentikan akses mikrofon
                    recordButton.textContent = 'Mulai Rekam';
                    isRecording = false;
                } else {
                    // Mulai rekaman baru
                    audioChunks = []; // Reset chunks
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            channelCount: 1,
                            sampleRate: 16000,
                            sampleSize: 16
                        }
                    });
                    
                    mediaRecorder = new MediaRecorder(mediaStream);
                    
                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { 
                        type: 'audio/wav; codecs=pcm' 
                        });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPreview.src = audioUrl;
                        
                        // Konversi ke File
                        const file = new File([audioBlob], 'recording.wav', {
                            type: 'audio/wav',
                            lastModified: Date.now()
                        });
                        
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        audioInput.files = dataTransfer.files;
                        
                        URL.revokeObjectURL(audioUrl); // Bersihkan memory
                    };
    
                    mediaRecorder.start(1000); // Ambil data tiap 1 detik
                    recordButton.textContent = 'Stop Rekam';
                    isRecording = true;
                }
            } catch (err) {
                console.error('Error mengakses mikrofon:', err);
                recordButton.disabled = true;
            }
        });
    </script>
</body>
</html>